<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			@import url(style.css);
		</style>
		<script src="https://unpkg.com/split.js/dist/split.min.js"></script>
		
        <link rel="stylesheet" href="codemirror/lib/codemirror.css">
        <link rel="stylesheet" href="codemirror/addon/hint/show-hint.css">
        <script src="codemirror/lib/codemirror.js"></script>
        <script src="codemirror/addon/hint/show-hint.js"></script>
        <script src="codemirror/addon/hint/xml-hint.js"></script>
        <script src="codemirror/mode/xml/xml.js"></script>

		<!-- resizable -->
		<script>
			document.addEventListener("DOMContentLoaded", function() {
				var resizable = document.querySelector('.resizable'),
				resizer = document.querySelector( '.resizer' ),
				iframe = document.querySelector( '#preview_iframe' ),
				startX, startY, startWidth, startHeight;
				
				resizer.addEventListener( 'mousedown', initDrag, false );

				function initDrag( e ) {
					startX = e.clientX;
					startY = e.clientY;
					iframe.style.pointerEvents  = 'none';				
					startWidth = parseInt( document.defaultView.getComputedStyle( resizable ).width, 10);
					startHeight = parseInt(document.defaultView.getComputedStyle( resizable ).height, 10);
					document.documentElement.addEventListener('mousemove', doDrag, false);
					document.documentElement.addEventListener('mouseup', stopDrag, false);
				}

				function doDrag(e) {
					resizable.style.width = (startWidth + e.clientX - startX) + 'px';
					resizable.style.height = (startHeight + e.clientY - startY) + 'px';
				}

				function stopDrag(e) {
					iframe.style.pointerEvents  = '';
					document.documentElement.removeEventListener('mousemove', doDrag, false);    
					document.documentElement.removeEventListener('mouseup', stopDrag, false);
				}
			});
		</script>

        <!-- pick example -->
        <script>
            function pickExample() {
                let item = document.querySelector("#exampleList").value;
                if(item && item.trim() != "") {
                    fetch(item)
                    .then(response => response.text())
                    .then(text => editor.doc.setValue(text));
                }
            }
        </script>

		<!-- editor configuration -->
		<script>
			var editor;
			window.onload = () => {
				var sizes = localStorage.getItem('split-sizes')
				if (sizes) {
					sizes = JSON.parse(sizes)
				} else {
					sizes = [50, 50] // default sizes
				}
				Split(['#editor', '#preview_background'] , 
				{
					sizes: sizes,
					gutterSize: 10,
					onDragEnd: function (sizes) {
						localStorage.setItem('split-sizes', JSON.stringify(sizes))
					}
				});

                var basic_widget_spec = {
                    attrs: {
                    },
                    children: []
                };
                var basic_widgets = ["flex","container","label","button","textbox","checkbox","image","list","scroll","slider","spinner","split","switch","stepper","painter"];

                var tags = {
                    //available top elements
                    "!top": ["flex","container"],

                    //available common attribute
                    "!attrs": {
                        class: null,
                        id: null,
                        flex: ["1"],
                        lens: null
                    },
                    flex: {
                        attrs: {
                            direction : ["row","column"],
                            axis_alignment : [],
                            cross_axis_alignment : []
                        },
                        children: ["spacer"].concat(basic_widgets)
                    },
                    container: {
                        attrs: {
                        },
                        children: basic_widgets
                    },
                    label: basic_widget_spec,
                    button: basic_widget_spec,
                    textbox: {
                        attrs : {
                            placeholder : null
                        },
                        children : []
                    },
                    checkbox: basic_widget_spec,
                    image: basic_widget_spec,
                    list: basic_widget_spec,
                    scroll: basic_widget_spec,
                    slider: basic_widget_spec,
                    spinner: basic_widget_spec,
                    split: {
                        attrs : {
                            direction : ["row", "column"],
                            split_point : [0,1],
                            min_size : ["0.2 , 0.2", "0.5 , 0.5" ],
                            bar_size : [.1 , 1.],
                            min_bar_area : [.1 , 1.],
                            draggable : [true, false],
                            solid_bar : [true, false]
                        },
                        children : basic_widgets
                    },
                    stepper: basic_widget_spec,
                    switch: basic_widget_spec,
                    painter: basic_widget_spec,

                };
          
                function completeAfter(cm, pred) {
                    var cur = cm.getCursor();
                    if (!pred || pred()) setTimeout(function() {
                    if (!cm.state.completionActive)
                        cm.showHint({completeSingle: false});
                    }, 100);
                    return CodeMirror.Pass;
                }
          
                function completeIfAfterLt(cm) {
                    return completeAfter(cm, function() {
                        var cur = cm.getCursor();
                        return cm.getRange(CodeMirror.Pos(cur.line, cur.ch - 1), cur) == "<";
                    });
                }
          
                function completeIfInTag(cm) {
                    return completeAfter(cm, function() {
                    var tok = cm.getTokenAt(cm.getCursor());
                        if (tok.type == "string" && (!/['"]/.test(tok.string.charAt(tok.string.length - 1)) || tok.string.length == 1)) return false;
                        var inner = CodeMirror.innerMode(cm.getMode(), tok.state).state;
                        return inner.tagName;
                    });
                }
           
                editor = CodeMirror.fromTextArea(document.getElementById("code"), {
                    mode: "xml",
                    lineNumbers: true,
                    extraKeys: {
                        "'<'": completeAfter,
                        "'/'": completeIfAfterLt,
                        "' '": completeIfInTag,
                        "'='": completeIfInTag,
                        "Ctrl-Space": "autocomplete"
                    },
                    hintOptions: {schemaInfo: tags},
                });
                editor.on('change', (inst, change) => {
                        let src = editor.doc.getValue();
                        src = '<sc'+'ript type="module" src="druid-tag.js"></sc'+'ript>' + src;
                        src = `<style>
                            html,body {width:100%; height:100%; overflow:hidden}
                            flex { display:flex }
                            custom { display:none }
                            </style>`
                        + src;
                        let preview = document.querySelector("#preview iframe");
                        preview.srcdoc = src;
                    }
                );
			}
		</script>
	</head>
	<body>
		<div class="split">
			<div id="editor">
                <select id="exampleList" onchange="pickExample()">
                    <option value="">-- SELECT EXAMPLE --</option>
                    <optgroup label="Basic">
                        <option value="ex/basic.xml">SIMPLE</option>
                        <option value="ex/basic_lens.xml">Lens</option>
                        <option value="ex/basic_style.xml">Style widget</option>
                        <option value="ex/basic_style_order.xml">Style order</option>
                    </optgroup>
                    <optgroup label="Custom Widget">
                        <option value="ex/custom_widget.xml">Custom widget</option>
                        <option value="ex/custom_widget_native.rs">Custom widget native</option>
                    </optgroup>
                    <optgroup label="Drawable Widget">
                        <option value="ex/drawable_shapes.xml">Draw shape</option>
                        <option value="ex/drawable_background.xml">Drawable as background</option>
                    </optgroup>
                    <optgroup label="Sample form">
                        <option value="ex/sample_login.xml">Login form</option>
                        <option value="ex/sample_input.xml">Input form</option>
                        <option value="ex/sample_file_explorer.xml">File explore form</option>
                    </optgroup>
                </select>
                <label style="color:lightgray">Ctrl+Space show the hint</label>
                <textarea id="code" name="code"></textarea>
            </div>
			<div id="preview_background">
				<div id="preview" class="resizable">
					<iframe id="preview_iframe"></iframe>
					<div class='resizer'>&nbsp;</div>
				</div>
			</div>
		</div>		
	</body>
</html>